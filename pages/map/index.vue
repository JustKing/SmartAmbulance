<template>
  <client-only>
    <yandex-map
      :coords="coords"
      :zoom="12"
      @map-was-initialized="initialized"
      style="width: 100%; height: 100%"
    >
    </yandex-map>
  </client-only>
</template>

<script lang="ts">
import { Vue, Component, Watch } from "nuxt-property-decorator";
import { userModule, callModule } from "@/plugins/store-namespaces";

// @todo вынести в компонент Map
@Component
export default class Map extends Vue {
  public layout(ctx: any) {
    return ctx.isMobile ? "default" : "noMobile";
  }

  public currentMap: any;

  @userModule.State("coords") coords!: [number, number];
  @callModule.State("status") status!: string;
  @callModule.State("id") id!: number;
  @callModule.Action("setState") setState!: any;

  /**
   * @description Инициализация карты
   */
  public initialized(map: any) {
    this.currentMap = map;
  }

  @Watch("status")
  onStatusChange(val: string) {
    if (val === "В пути") {
      setTimeout(() => {
        this.$toast.success(this.status);
        this.watchAmbulance(this.currentMap);
      }, 1500);
    }
  }

  /**
   * @description Пример отображения скорой помощи
   */
  public watchAmbulance(map: any) {
    let routeGlobal: any = undefined;
    let wind: any = window;
    let points = [
      // убрать
      [69.044085, 61.003845999990965],
      [69.04403472860527, 61.00390938566258],
      [69.04396143201836, 61.0040016582965],
      [69.04388965813172, 61.00409196534635],
      [69.04381510431791, 61.004185770144964],
      [69.04374192426467, 61.00427784645609],
      [69.0436727999575, 61.00436481976273],
      [69.0436106182158, 61.00444305782273],
      [69.04354230207288, 61.00453106844739],
      [69.04349462017606, 61.004593116043914],
      [69.04344197256947, 61.00466162542943],
      [69.04338750212001, 61.00473261329879],
      [69.04335935878228, 61.00476930014976],
      [69.04329008595514, 61.004859602228],
      [69.04321998504257, 61.004949976908236],
      [69.0431485035069, 61.00504315298731],
      [69.04308049032782, 61.005132387618545],
      [69.04301230075133, 61.005221412898976],
      [69.04294265474378, 61.00531233963104],
      [69.04287969963859, 61.00539453101834],
      [69.04281518815802, 61.005478754340196],
      [69.04274753815172, 61.00556707518176],
      [69.0426833406517, 61.005650310561656],
      [69.04261709353855, 61.00573518136123],
      [69.04255241275129, 61.00581804550235],
      [69.0424919468845, 61.00589550980559],
      [69.04243412608835, 61.00596968857299],
      [69.04237699144221, 61.00604313197448],
      [69.04231022321274, 61.00612895881012],
      [69.04224643674604, 61.00621095275595],
      [69.04218360325221, 61.00629172170833],
      [69.04212284962831, 61.006369817103916],
      [69.0420587884175, 61.00645216421799],
      [69.04198951518754, 61.006541211092035],
      [69.04192909383582, 61.00661887937025],
      [69.04187042651306, 61.00669440122003],
      [69.04181808297305, 61.00676178268311],
      [69.04176884567325, 61.00682516550547],
      [69.0417458220442, 61.00685476077999],
      [69.04148288604104, 61.007185371040734],
      [69.04141060586136, 61.00726914574476],
      [69.04131145600503, 61.00738398032411],
      [69.04122915722364, 61.00747929812178],
      [69.04114417850452, 61.00757771980213],
      [69.04106554768097, 61.00766878939999],
      [69.04099672144663, 61.00774850340023],
      [69.0409298985982, 61.007825897094754],
      [69.04085996040538, 61.00790695645373],
      [69.04080148227519, 61.007974776138276],
      [69.04072993914247, 61.00805774788644],
      [69.04066394992054, 61.00813427851762],
      [69.04060361386067, 61.00820425292573],
      [69.04054603382603, 61.00827752843582],
      [69.04046599999998, 61.00838699999098],
      [69.04020941372148, 61.008348618696765],
      [69.04002199482147, 61.00832098758832],
      [69.03983796349111, 61.008293855908185],
      [69.03964600678442, 61.008265555792356],
      [69.03944413494992, 61.00823579389242],
      [69.03926162344466, 61.00820888627961],
      [69.03908505691665, 61.00818271059557],
      [69.03892133436966, 61.008158245095515],
      [69.03876824450779, 61.008135339604806],
      [69.0386703852148, 61.00812069777878],
      [69.03854046543312, 61.00810125902357],
      [69.03811352339123, 61.00804069526111],
      [69.03792651590722, 61.008015389680295],
      [69.03772320979611, 61.007987841426775],
      [69.0375386900674, 61.00796283875349],
      [69.0373548376181, 61.00793792649747],
      [69.03717816117452, 61.00791398956945],
      [69.03702954250159, 61.00789385413634],
      [69.03686980215596, 61.007872211895965],
      [69.03670181130545, 61.007849451845274],
      [69.03656948659794, 61.00783152398167],
      [69.03644789152729, 61.00781504981077],
      [69.03637046431916, 61.007804559672934],
      [69.03628569158035, 61.007793074334124],
      [69.035291, 61.00695499999098],
      [69.03530049133887, 61.00699786410207],
      [69.03532029366663, 61.00708729396932],
      [69.03534012419095, 61.00717685117596],
      [69.03535892445018, 61.007261755572486],
      [69.0353767389888, 61.00734220832757],
      [69.03539395104741, 61.00741994020514],
      [69.0354106184927, 61.00749521253875],
      [69.03542314648334, 61.007551790560996],
      [69.03542778091166, 61.007572720237285],
      [69.03542864251469, 61.00757661134769],
      [69.0354291679946, 61.00757898448279],
      [69.03544854502134, 61.00766581633172],
      [69.03550776036604, 61.00789009538658],
      [69.0355358087925, 61.00799254842543],
      [69.03556360019788, 61.008094062638456],
      [69.03558814180711, 61.0081837062571],
      [69.03561551275271, 61.008283684648326],
      [69.03564241401672, 61.008381947424446],
      [69.03567239292347, 61.00849145196664],
      [69.03570017847753, 61.008592944806374],
      [69.03572817374443, 61.00869439276888],
      [69.0357584240266, 61.00880146916451],
      [69.03578726638587, 61.00890356127789],
      [69.03581751333634, 61.00901061956311],
      [69.03584599792885, 61.00911144002864],
      [69.03587698570202, 61.009221120436365],
      [69.03590451573943, 61.00931856227924],
      [69.03593103017951, 61.00941240944209],
      [69.03596014160084, 61.00951544855183],
      [69.03598782260799, 61.009613424748196],
      [69.03601574724082, 61.009715369516655],
      [69.03603543312778, 61.00981244080179],
    ];

    let intervalId = setInterval(() => {
      if (points.length <= 1) clearInterval(intervalId);
      wind.ymaps
        .route([
          [points[points.length - 1][1], points[points.length - 1][0]],
          [points[0][1], points[0][0]],
        ])
        .then((route: any) => {
          if (routeGlobal !== undefined) {
            map.geoObjects.remove(routeGlobal);
          }
          routeGlobal = route;
          map.geoObjects.add(routeGlobal);
        });
      points.pop();
      if (points.length === 0) {
        this.setState({ id: this.id, state: 4 }).then(() =>
          this.$toast.success(this.status)
        );
      }
    }, 500);
  }
}
</script>
